name: Update Malicious NPM Package Database

on:
  workflow_dispatch:
    inputs:
      days:
        description: "Number of days ago to scan"
        required: true
        default: "7"
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches:
      - main

jobs:
  update-malicious-db:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # Clone only the malicious NPM advisories directory
      - name: Clone OSV malicious NPM advisories (sparse)
        run: |
          git clone --filter=blob:none --no-checkout --sparse https://github.com/ossf/malicious-packages.git
          cd malicious-packages
          git sparse-checkout set osv/malicious/npm
          git checkout main

      # Generate advisories.txt based on recent commits
      - name: Generate advisories list
        run: |
          cd malicious-packages
          if [ -n "${{ github.event.inputs.days }}" ]; then
            RANGE="${{ github.event.inputs.days }} days ago"
          else
            RANGE="2 hours ago"
          fi
          git log --since="$RANGE" \
            --pretty=format: --name-only -- osv/malicious/npm \
            | sort -u \
            > ../advisories.txt

      # Install Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Run processing script
      - name: Run malicious NPM processor
        run: node index.js

      # Prepare files (update README, split JSON, rename chunks)
      - name: Process dataset updates
        run: |
          if ! git diff --quiet; then
            echo "Changes detected — processing..."

            COUNT=$(jq 'keys | length' malicious_npm_packages.json)

            # Update README count
            sed -i.bak "s|- Total Malicious Packages Added: [0-9][0-9]*|- Total Malicious Packages Added: $COUNT|" README.md
            rm -f README.md.bak

            # Recreate chunked directory
            rm -rf malicious_npm_packages_chunked
            mkdir -p malicious_npm_packages_chunked

            # Split JSON
            split -d -a 2 -b 2m malicious_npm_packages.json malicious_npm_packages_chunked/chunk_

            # Add .json suffix
            for f in malicious_npm_packages_chunked/chunk_*; do
              [[ "$f" != *.json ]] && mv "$f" "$f.json"
            done

            # Commit metadata
            NEW_PKGS=$(jq '.newPackages' changes_summary.json)
            NEW_VERS=$(jq '.newVersions' changes_summary.json)
            TOTAL_CHANGES=$((NEW_PKGS + NEW_VERS))
            TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

            echo "TOTAL_CHANGES=$TOTAL_CHANGES" >> $GITHUB_ENV
            echo "NEW_PKGS=$NEW_PKGS" >> $GITHUB_ENV
            echo "NEW_VERS=$NEW_VERS" >> $GITHUB_ENV
            echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          else
            echo "No changes detected — skipping processing."
          fi

      # Auto-commit only specific files
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          add: |
            malicious_npm_packages.json
            CHANGELOG.md
            README.md
            malicious_npm_packages_chunked
          commit_message: "${{ env.TIMESTAMP }}: Updated database with ${{ env.TOTAL_CHANGES }} malicious packages (New: ${{ env.NEW_PKGS }}, Updated Versions: ${{ env.NEW_VERS }})"
          commit_options: "--no-verify"
          branch: main
        if: env.TOTAL_CHANGES != '' && env.TOTAL_CHANGES != '0'
